on_off_detection:
    on_off_threshold_1:
        method: threshold
        sorting_condition: ks2_5_catgt_Th=12-10_lam=50_8s-batches_postpro_1
        params:
            binsize: 0.010
            smooth_sd_counts: 3
            binsize_smoothed_count_hist: 0.02 # 0.05
            smooth_sd_smoothed_count_hist: 1 # Units of "binsize_smoothed_count_hist"
            binsize_duration_hist: 0.01 # 
            count_threshold: null
            gap_threshold: null
    on_off_threshold_single_unit_1:
        method: threshold
        sorting_condition: ks2_5_catgt_Th=12-10_lam=50_8s-batches_postpro_1
        params:
            binsize: 0.010
            smooth_sd_counts: 1
            binsize_smoothed_count_hist: 0.02
            smooth_sd_smoothed_count_hist: null
            binsize_duration_hist: 0.01
            count_threshold: 0.0 # ON for all single spikes
            gap_threshold: null
    on_off_threshold_single_unit_2:
        method: threshold
        sorting_condition: None
        params:
            binsize: 0.010
            smooth_sd_counts: 1
            binsize_smoothed_count_hist: 0.02
            smooth_sd_smoothed_count_hist: null
            binsize_duration_hist: 0.01
            count_threshold: 0.0 # ON for all single spikes
            gap_threshold: 0.0  # Don't merge any ON-periods

#####################################
#####################################
#####################################

ks_postprocessing:
    postpro_df:
        # [<module_name>: <module_params_dict>]
#         - kilosort_postprocessing: {}
        - noise_templates:
            noise_template_use_rf: False
            min_spread_threshold: 2
            mid_spread_threshold: 16
            max_spread_threshold: 25
            min_wavelet_peak_height: 0.0
            min_wavelet_peak_loc: 15
            max_wavelet_peak_loc: 25
            min_temporal_peak_location: 10
            max_temporal_peak_location: 30
#         - mean_waveforms:
#             c_Waves_snr_um: 160
#         - quality_metrics:
#             qm_isi_thresh: 0.0015  # Refractory period threshold in sec (to assess contamination). Allen default is 2.0msec for cortex and 1.0msec for thalamus
    postpro_1:
        # [<module_name>: <module_params_dict>]
#         - kilosort_postprocessing: {}
        - noise_templates:
            noise_template_use_rf: False
            # Check template spread
            min_spread_threshold: 2
            mid_spread_threshold: 16
            max_spread_threshold: 25
            # Don't check abnormal shape
            min_wavelet_peak_height: 0.0
            min_wavelet_peak_loc: 0
            max_wavelet_peak_loc: 50
            # Extremely lenient on temporal peak location
            min_temporal_peak_location: 2
            max_temporal_peak_location: 50
            # No spatial peak spread testing
            peak_locs_std_thresh: 20
#         - mean_waveforms:
#             c_Waves_snr_um: 160
#         - quality_metrics:
#             qm_isi_thresh: 0.0015  # Refractory period threshold in sec (to assess contamination). Allen default is 2.0msec for cortex and 1.0msec for thalamus
    postpro_2:
        # [<module_name>: <module_params_dict>]
        - kilosort_postprocessing: {}
        - noise_templates:
            noise_template_use_rf: False
            # Check template spread
            min_spread_threshold: 2
            mid_spread_threshold: 16
            max_spread_threshold: 25
            # Don't check abnormal shape
            min_wavelet_peak_height: 0.0
            min_wavelet_peak_loc: 0
            max_wavelet_peak_loc: 50
            # Extremely lenient on temporal peak location
            min_temporal_peak_location: 2
            max_temporal_peak_location: 50
            # No spatial peak spread testing
            peak_locs_std_thresh: 20
#         - mean_waveforms:
#             c_Waves_snr_um: 160
#         - quality_metrics:
#             qm_isi_thresh: 0.0015  # Refractory period threshold in sec (to assess contamination). Allen default is 2.0msec for cortex and 1.0msec for thalamus
    metrics_isi=1:
        # [<module_name>: <module_params_dict>]
        - quality_metrics:
            qm_isi_thresh: 0.0010  # Refractory period threshold in sec (to assess contamination). Allen default is 2.0msec for cortex and 1.0msec for thalamus
    metrics_isi=1_5:
        # [<module_name>: <module_params_dict>]
        - quality_metrics:
            qm_isi_thresh: 0.0015  # Refractory period threshold in sec (to assess contamination). Allen default is 2.0msec for cortex and 1.0msec for thalamus
    metrics_isi=2:
        # [<module_name>: <module_params_dict>]
        - quality_metrics:
            qm_isi_thresh: 0.0020  # Refractory period threshold in sec (to assess contamination). Allen default is 2.0msec for cortex and 1.0msec for thalamus
    metrics_all_isi:
        # [<module_name>: <module_params_dict>]
        - quality_metrics:
            qm_isi_thresh: [0.0020, 0.0015, 0.001]  # Refractory period threshold in sec (to assess contamination). Allen default is 2.0msec for cortex and 1.0msec for thalamus
            tbin_sec: 0.0005  # Refractory period threshold in sec (to assess contamination). Allen default is 2.0msec for cortex and 1.0msec for thalamus

#####################################
#####################################
#####################################

sorting:
    # Kilosort 1
    ks1_base: &ks1_base
        detect_threshold: 6
        car: True
        useGPU: True
        freq_min: 300
        freq_max: 6000
        ntbuff: 64
        Nfilt: null
        NT: null
    ks1_catgt_df:
        - kilosort
        -
            <<: *ks1_base
            car: False

    # Kilosort 2.5
    ks2_5_base: &ks2_5_base
        detect_threshold: 6
        projection_threshold: [10, 4]
        preclust_threshold: 8
        car: True
        minFR: 0.1
        minfr_goodchannels: 0.1
        nblocks: 5
        do_correction: True
        sig: 20
        lam: 10
        freq_min: 150
        sigmaMask: 30
        nPCs: 3
        ntbuff: 64
        nfilt_factor: 4
        NT: null
        keep_good_only: False
        chunk_mb: 200000
        n_jobs_bin: 50 
    ks2_5_catgt_df:
        - kilosort2_5
        - &catgt_df
            <<: *ks2_5_base
            car: False
    ks2_5_raw_df:
        - kilosort2_5
        -
            <<: *ks2_5_base
            car: True
    ks2_5_catgt_Th=12-10_lam=50_nodrift:
        - kilosort2_5
        -
            <<: *catgt_df
            do_correction: 0
            projection_threshold: [12, 10]
            lam: 50
    ks2_5_catgt_Th=12-10_lam=50_8s-batches:
        - kilosort2_5
        -
            <<: *catgt_df
            projection_threshold: [12, 10]
            lam: 50
            NT: 262272


    # Kilosort 3
    ks3_base: &ks3_base
        detect_threshold: 6
        projection_threshold: [9, 9]
        preclust_threshold: 8
        car: True
        minFR: 0.2
        minfr_goodchannels: 0.2
        nblocks: 5
        sig: 20
        freq_min: 300
        sigmaMask: 30
        nPCs: 3
        ntbuff: 64
        nfilt_factor: 4
        NT: null
        keep_good_only: False
        chunk_mb: 500
    ks3_catgt_df:
        - kilosort3
        -
            <<: *ks3_base
            car: False
            
#####################################
#####################################
#####################################
